<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radashkovichy map 1888</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        #map {
            flex: 1;
            min-width: 50%;
            height: 100vh;
        }

        #sidebar {
            width: 500px;
            height: 100vh;
            background: #f5f5f5;
            border-left: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar-header {
            background: #2c5f2d;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #sidebar-controls {
            padding: 10px 20px;
            background: white;
            border-bottom: 1px solid #ccc;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #table-container {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        #data-table thead {
            position: sticky;
            top: 0;
            background: #2c5f2d;
            color: white;
            z-index: 10;
        }

        #data-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #1a3a1b;
            cursor: pointer;
            user-select: none;
        }

        #data-table th:hover {
            background: #3a7a3d;
        }

        #data-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        #data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #data-table tbody tr:hover {
            background-color: #f0f8f0;
        }

        #data-table tbody tr.selected {
            background-color: #d4edda;
            font-weight: bold;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #data-table tbody tr:nth-child(even):hover {
            background-color: #f0f8f0;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .type-land {
            background: #90EE90;
            color: #2d5f2d;
        }

        .type-building {
            background: #FFD700;
            color: #8B6914;
        }

        .type-subdivision {
            background: #FFB6C1;
            color: #8B2252;
        }

        .type-street {
            background: #808080;
            color: white;
        }

        /* Адаптивность для планшетов */
        @media (max-width: 1024px) {
            #sidebar {
                width: 400px;
            }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            #map {
                height: 50vh;
                min-width: 100%;
            }

            #sidebar {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 2px solid #ccc;
            }
        }
        
        /* Street labels */
        .street-label {
            background: transparent;
            border: none;
            box-shadow: none;
            font-size: 11px;
            font-weight: bold;
            color: #333;
            text-shadow: 
                -1px -1px 0 #fff,
                1px -1px 0 #fff,
                -1px 1px 0 #fff,
                1px 1px 0 #fff,
                -2px 0 0 #fff,
                2px 0 0 #fff,
                0 -2px 0 #fff,
                0 2px 0 #fff;
            white-space: nowrap;
        }
        
        /* Plot numbers */
        .field-label {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #333;
            border-radius: 3px;
            padding: 2px 5px;
            font-size: 12px;
            font-weight: bold;
            color: #333;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        
        /* Popup */
        .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }
        
        .popup-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 5px;
            color: #2c5f2d;
        }
        
        .popup-info {
            font-size: 12px;
            margin: 3px 0;
        }
        
        /* Legend */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 20px;
            font-size: 12px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .legend-item {
            margin: 3px 0;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #333;
            vertical-align: middle;
        }
        
        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="loading">Map loading...</div>

    <div id="container">
        <div id="map"></div>

        <div id="sidebar">
            <div id="sidebar-header">
                База данных участков
            </div>

            <div id="sidebar-controls">
                <input type="text" id="search-input" placeholder="Поиск по номеру, владельцу или улице...">
            </div>

            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th data-sort="number">№</th>
                            <th data-sort="type">Тип</th>
                            <th data-sort="owner">Владелец</th>
                            <th data-sort="length">Длина</th>
                            <th data-sort="width">Ширина</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <script>
        // Ждём полной загрузки страницы
        window.addEventListener('load', function() {
            // Убираем индикатор загрузки
            document.getElementById('loading').style.display = 'none';
            
            // Проверяем что Leaflet загружен
            if (typeof L === 'undefined') {
                alert('Error: The library Leaflet was not loaded. Check your internet connection.');
                return;
            }
            
            // ========================================
            // НАСТРОЙКИ КАРТЫ
            // ========================================
            
            // ИЗМЕНИТЕ ЭТИ КООРДИНАТЫ на правильные!
            // Формат: [широта, долгота] в градусах (WGS84)
            const mapCenter = [54.154854, 27.240569]; 
            const initialZoom = 18;
            
            // ========================================
            // ИНИЦИАЛИЗАЦИЯ КАРТЫ
            // ========================================
            
            const map = L.map('map').setView(mapCenter, initialZoom);
            
            // Базовая карта OpenStreetMap
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 22,
                maxNativeZoom: 19
            }).addTo(map);
            
            // ========================================
            // СТИЛИ ДЛЯ СЛОЁВ
            // ========================================

            // Определяем тип фичи по исходному слою
            function getFeatureStyle(feature) {
                const sourceLayer = feature.properties.source_layer;

                // Для линий
                if (sourceLayer === 'lines') {
                    return {
                        color: feature.properties.stroke_color || '#808080',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1,
                        dashArray: feature.properties.dash_array || ''
                    };
                }

                // Для полигонов (участки земли)
                if (sourceLayer === 'polygons1') {
                    return {
                        fillColor: feature.properties.fill_color || '#90EE90',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#2d5f2d',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Для полигонов (части участков)
                if (sourceLayer === 'polygons2') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFB6C1',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#C71585',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Для полигонов (дома)
                if (sourceLayer === 'polygons3') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFD700',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#DAA520',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Дефолтный стиль
                return {
                    fillColor: '#cccccc',
                    fillOpacity: 0.5,
                    color: '#666666',
                    weight: 2,
                    opacity: 1
                };
            }

            // ========================================
            // ПЕРЕМЕННЫЕ ДЛЯ СЛОЁВ
            // ========================================

            let combinedLayer;
            
            // ========================================
            // ПАРАЛЛЕЛЬНАЯ ЗАГРУЗКА ВСЕХ СЛОЁВ
            // ========================================

            Promise.all([
                fetch('data/map1-polygons.geojson').then(r => r.json()),
                fetch('data/map1-buildings.geojson').then(r => r.json()),
                fetch('data/map1-buildings2.geojson').then(r => r.json()),
                fetch('data/map1-lines.geojson').then(r => r.json())
            ])
            .then(([polygons1Data, polygons3Data, polygons2Data, linesData]) => {
                console.log('✓ Все файлы загружены');

                // Помечаем каждую фичу исходным слоем для правильного стилизования
                polygons1Data.features.forEach(f => f.properties.source_layer = 'polygons1');
                polygons2Data.features.forEach(f => f.properties.source_layer = 'polygons2');
                polygons3Data.features.forEach(f => f.properties.source_layer = 'polygons3');
                linesData.features.forEach(f => f.properties.source_layer = 'lines');

                // Объединяем все фичи в один массив
                const allFeatures = [
                    ...polygons1Data.features,
                    ...polygons2Data.features,
                    ...polygons3Data.features,
                    ...linesData.features
                ];

                // Сортируем по layer_order (если нет - в конец)
                allFeatures.sort((a, b) => {
                    const orderA = a.properties.layer_order !== undefined ? a.properties.layer_order : Infinity;
                    const orderB = b.properties.layer_order !== undefined ? b.properties.layer_order : Infinity;
                    return orderA - orderB;
                });

                console.log(`✓ Отсортировано ${allFeatures.length} объектов по layer_order`);

                // Создаём единый GeoJSON объект
                const combinedGeoJSON = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };

                // Создаём единый слой
                combinedLayer = L.geoJSON(combinedGeoJSON, {
                    style: getFeatureStyle,
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const sourceLayer = props.source_layer;

                        // Popup для участков земли
                        if (sourceLayer === 'polygons1') {
                            let popupContent = '<div class="popup-title">Участок земли</div>';

                            if (props.field_Number) {
                                popupContent += `<div class="popup-info"><b>Номер:</b> ${props.field_Number}</div>`;
                            }
                            if (props['first and last name of the owners']) {
                                popupContent += `<div class="popup-info"><b>Владелец:</b> ${props['first and last name of the owners']}</div>`;
                            }
                            if (props['length of land plots']) {
                                popupContent += `<div class="popup-info"><b>Длина:</b> ${props['length of land plots']}</div>`;
                            }
                            if (props['width of land plots']) {
                                popupContent += `<div class="popup-info"><b>Ширина:</b> ${props['width of land plots']}</div>`;
                            }

                            layer.bindPopup(popupContent);

                            // Метка с номером участка
                            if (props.field_Number) {
                                const center = layer.getBounds().getCenter();
                                L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'field-label',
                                        html: props.field_Number,
                                        iconSize: null
                                    })
                                }).addTo(map);
                            }

                            // Hover эффекты
                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // Popup для частей участков
                        if (sourceLayer === 'polygons2') {
                            layer.bindPopup('<div class="popup-title">Часть участка</div>');

                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // Popup для домов
                        if (sourceLayer === 'polygons3') {
                            layer.bindPopup('<div class="popup-title">Дом</div>');

                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // Popup для границ улиц
                        if (sourceLayer === 'lines') {
                            let popupContent = '<div class="popup-title">Граница улицы</div>';
                            if (props['street name']) {
                                popupContent += `<div class="popup-info"><b>Название:</b> ${props['street name']}</div>`;
                            }
                            layer.bindPopup(popupContent);

                            // Метка с названием улицы
                            if (props['street name'] && props['street name'] !== null && props['street name'] !== '') {
                                const center = layer.getBounds().getCenter();
                                L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'street-label',
                                        html: props['street name'],
                                        iconSize: null
                                    })
                                }).addTo(map);
                            }
                        }
                    }
                }).addTo(map);

                console.log('✓ Единый слой создан и добавлен на карту');

                // Добавляем контроль слоя
                L.control.layers(null, {
                    "Историческая карта 1888": combinedLayer
                }, {
                    collapsed: false,
                    position: 'topright'
                }).addTo(map);

                // ========================================
                // ЗАПОЛНЕНИЕ ТАБЛИЦЫ ДАННЫМИ
                // ========================================

                saveTableData(allFeatures);
                populateTable(allTableData);
            })
            .catch(error => {
                console.error('Ошибка загрузки слоёв:', error);
                alert('Не удалось загрузить данные карты. Проверьте наличие файлов в папке data/');
            });

            // ========================================
            // ФУНКЦИИ ДЛЯ РАБОТЫ С ТАБЛИЦЕЙ
            // ========================================

            function getTypeName(sourceLayer) {
                const types = {
                    'polygons1': 'Участок',
                    'polygons2': 'Часть',
                    'polygons3': 'Дом',
                    'lines': 'Улица'
                };
                return types[sourceLayer] || 'Неизвестно';
            }

            function getTypeBadgeClass(sourceLayer) {
                const classes = {
                    'polygons1': 'type-land',
                    'polygons2': 'type-subdivision',
                    'polygons3': 'type-building',
                    'lines': 'type-street'
                };
                return classes[sourceLayer] || '';
            }

            function populateTable(features) {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = '';

                let rowCount = 0;

                features.forEach((feature, index) => {
                    const props = feature.properties;
                    const sourceLayer = props.source_layer;

                    // Пропускаем линии без названия улицы (они не несут полезной информации для таблицы)
                    if (sourceLayer === 'lines' && !props['street name']) {
                        return;
                    }

                    const row = document.createElement('tr');
                    row.dataset.featureIndex = index;

                    // Номер участка или название улицы
                    let displayNumber = '-';
                    if (sourceLayer === 'polygons1') {
                        displayNumber = props.field_Number || '-';
                    } else if (sourceLayer === 'lines') {
                        displayNumber = props['street name'] || '-';
                    }

                    // Владелец
                    let owner = '-';
                    if (props['first and last name of the owners']) {
                        owner = props['first and last name of the owners'];
                    } else if (props['First and last name of the owners']) {
                        owner = props['First and last name of the owners'];
                    }

                    // Длина
                    const length = props['length of land plots'] || props['Length of land plots'] || '-';

                    // Ширина
                    const width = props['width of land plots'] || props['Width of land plots'] || '-';

                    // Тип
                    const typeName = getTypeName(sourceLayer);
                    const typeBadgeClass = getTypeBadgeClass(sourceLayer);

                    row.innerHTML = `
                        <td>${displayNumber}</td>
                        <td><span class="type-badge ${typeBadgeClass}">${typeName}</span></td>
                        <td>${owner}</td>
                        <td>${length}</td>
                        <td>${width}</td>
                    `;

                    tableBody.appendChild(row);
                    rowCount++;
                });

                console.log(`✓ Таблица заполнена: ${rowCount} записей`);

                // Обновляем заголовок с количеством записей
                document.getElementById('sidebar-header').textContent =
                    `База данных участков (${rowCount})`;
            }

            // ========================================
            // ПОИСК В ТАБЛИЦЕ
            // ========================================

            let allTableData = [];

            // Сохраняем данные для поиска
            function saveTableData(features) {
                allTableData = features.filter(feature => {
                    const sourceLayer = feature.properties.source_layer;
                    // Пропускаем линии без названия улицы
                    return !(sourceLayer === 'lines' && !feature.properties['street name']);
                });
            }

            // Функция поиска
            function searchTable(searchTerm) {
                const term = searchTerm.toLowerCase().trim();

                if (term === '') {
                    // Показываем все данные
                    populateTable(allTableData);
                    return;
                }

                // Фильтруем данные
                const filtered = allTableData.filter(feature => {
                    const props = feature.properties;

                    // Поиск по номеру участка
                    const fieldNumber = String(props.field_Number || '').toLowerCase();
                    if (fieldNumber.includes(term)) return true;

                    // Поиск по имени владельца
                    const owner = String(props['first and last name of the owners'] || props['First and last name of the owners'] || '').toLowerCase();
                    if (owner.includes(term)) return true;

                    // Поиск по названию улицы
                    const street = String(props['street name'] || '').toLowerCase();
                    if (street.includes(term)) return true;

                    return false;
                });

                populateTable(filtered);
            }

            // Обработчик поиска (с задержкой для оптимизации)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTable(e.target.value);
                }, 300);
            });
            
            // ========================================
            // ЛЕГЕНДА
            // ========================================
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title">Легенда</div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#90EE90; border-color:#2d5f2d;"></span>
                        Участки земли
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFB6C1; border-color:#C71585;"></span>
                        Части участков
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFD700; border-color:#DAA520;"></span>
                        Дома
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#808080;"></span>
                        Границы улиц
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
            
            // ========================================
            // МАСШТАБ
            // ========================================
            
            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);
            
            console.log('🗺️ Карта инициализирована! Центр:', mapCenter, 'Zoom:', initialZoom);
        });
    </script>
</body>
</html>
