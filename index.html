<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radashkovichy map 1888</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet TextPath CSS -->
    <style>
        .leaflet-text-path {
            font-size: 12px;
            font-weight: bold;
            fill: #333;
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: opacity 0.3s;
        }

        .leaflet-text-path-hidden {
            opacity: 0;
        }
    </style>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        #map {
            flex: 1;
            min-width: 50%;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #sidebar {
            width: 500px;
            height: 100vh;
            background: #f5f5f5;
            border-left: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar-header {
            background: #2c5f2d;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #sidebar-controls {
            padding: 10px 20px;
            background: white;
            border-bottom: 1px solid #ccc;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #table-container {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        #data-table thead {
            position: sticky;
            top: 0;
            background: #2c5f2d;
            color: white;
            z-index: 10;
        }

        #data-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #1a3a1b;
            cursor: pointer;
            user-select: none;
        }

        #data-table th:hover {
            background: #3a7a3d;
        }

        #data-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        #data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #data-table tbody tr:hover {
            background-color: #f0f8f0;
        }

        #data-table tbody tr.selected {
            background-color: #d4edda;
            font-weight: bold;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #data-table tbody tr:nth-child(even):hover {
            background-color: #f0f8f0;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .type-land {
            background: #90EE90;
            color: #2d5f2d;
        }

        .type-building {
            background: #FFD700;
            color: #8B6914;
        }

        .type-subdivision {
            background: #FFB6C1;
            color: #8B2252;
        }

        .type-street {
            background: #808080;
            color: white;
        }

        /* Адаптивность для планшетов */
        @media (max-width: 1024px) {
            #sidebar {
                width: 400px;
            }
        }

        /* Адаптивность для мобильных */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            #map {
                height: 50vh;
                min-width: 100%;
            }

            #sidebar {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 2px solid #ccc;
            }
        }
        
        /* Plot numbers */
        .field-label {
            background: transparent;
            border: none;
            padding: 0;
            font-size: 14px;
            font-weight: bold;
            color: #2c5f2d;
            text-align: center;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .field-label-hidden {
            opacity: 0;
        }
        
        /* Popup */
        .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }

        .popup-info {
            font-size: 13px;
            margin: 5px 0;
        }
        
        /* Legend */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 20px;
            font-size: 12px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .legend-item {
            margin: 3px 0;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #333;
            vertical-align: middle;
        }
        
        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="loading">Map loading...</div>

    <div id="container">
        <div id="map"></div>

        <div id="sidebar">
            <div id="sidebar-header">
                База данных участков
            </div>

            <div id="sidebar-controls">
                <input type="text" id="search-input" placeholder="Поиск по номеру участка или владельцу...">
            </div>

            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th data-sort="number">№</th>
                            <th data-sort="type">Тип</th>
                            <th data-sort="owner">Владелец</th>
                            <th data-sort="length">Длина</th>
                            <th data-sort="width">Ширина</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Данные будут загружены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet TextPath Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js"></script>
    
    <script>
        // Ждём полной загрузки страницы
        window.addEventListener('load', function() {
            // Убираем индикатор загрузки
            document.getElementById('loading').style.display = 'none';
            
            // Проверяем что Leaflet загружен
            if (typeof L === 'undefined') {
                alert('Error: The library Leaflet was not loaded. Check your internet connection.');
                return;
            }
            
            // ========================================
            // НАСТРОЙКИ КАРТЫ
            // ========================================
            
            // ИЗМЕНИТЕ ЭТИ КООРДИНАТЫ на правильные!
            // Формат: [широта, долгота] в градусах (WGS84)
            const mapCenter = [54.154854, 27.240569]; 
            const initialZoom = 18;
            
            // ========================================
            // ИНИЦИАЛИЗАЦИЯ КАРТЫ
            // ========================================
            
            const map = L.map('map').setView(mapCenter, initialZoom);

            // Базовая карта OpenStreetMap
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 22,
                maxNativeZoom: 19
            }).addTo(map);
            
            // ========================================
            // СТИЛИ ДЛЯ СЛОЁВ
            // ========================================

            // Определяем тип фичи по исходному слою
            function getFeatureStyle(feature) {
                const sourceLayer = feature.properties.source_layer;

                // Для линий
                if (sourceLayer === 'lines') {
                    return {
                        color: feature.properties.stroke_color || '#808080',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1,
                        dashArray: feature.properties.dash_array || ''
                    };
                }

                // Для полигонов (участки земли)
                if (sourceLayer === 'polygons1') {
                    return {
                        fillColor: feature.properties.fill_color || '#90EE90',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#2d5f2d',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Для полигонов (части участков)
                if (sourceLayer === 'polygons2') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFB6C1',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#C71585',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Для полигонов (дома)
                if (sourceLayer === 'polygons3') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFD700',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#DAA520',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Дефолтный стиль
                return {
                    fillColor: '#cccccc',
                    fillOpacity: 0.5,
                    color: '#666666',
                    weight: 2,
                    opacity: 1
                };
            }

            // ========================================
            // ПЕРЕМЕННЫЕ ДЛЯ СЛОЁВ
            // ========================================

            let combinedLayer;
            let fieldLabelsGroup = L.layerGroup(); // Группа для номеров участков
            let streetLayers = []; // Массив для хранения линий улиц с названиями
            
            // ========================================
            // ПАРАЛЛЕЛЬНАЯ ЗАГРУЗКА ВСЕХ СЛОЁВ
            // ========================================

            Promise.all([
                fetch('data/map1-polygons.geojson').then(r => r.json()),
                fetch('data/map1-buildings.geojson').then(r => r.json()),
                fetch('data/map1-buildings2.geojson').then(r => r.json()),
                fetch('data/map1-lines.geojson').then(r => r.json())
            ])
            .then(([polygons1Data, polygons3Data, polygons2Data, linesData]) => {
                console.log('✓ Все файлы загружены');

                // Помечаем каждую фичу исходным слоем для правильного стилизования
                polygons1Data.features.forEach(f => f.properties.source_layer = 'polygons1');
                polygons2Data.features.forEach(f => f.properties.source_layer = 'polygons2');
                polygons3Data.features.forEach(f => f.properties.source_layer = 'polygons3');
                linesData.features.forEach(f => f.properties.source_layer = 'lines');

                // Объединяем все фичи в один массив
                const allFeatures = [
                    ...polygons1Data.features,
                    ...polygons2Data.features,
                    ...polygons3Data.features,
                    ...linesData.features
                ];

                // Сортируем по layer_order (если нет - в конец)
                allFeatures.sort((a, b) => {
                    const orderA = a.properties.layer_order !== undefined ? a.properties.layer_order : Infinity;
                    const orderB = b.properties.layer_order !== undefined ? b.properties.layer_order : Infinity;
                    return orderA - orderB;
                });

                console.log(`✓ Отсортировано ${allFeatures.length} объектов по layer_order`);

                // Создаём единый GeoJSON объект
                const combinedGeoJSON = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };

                // Создаём единый слой
                combinedLayer = L.geoJSON(combinedGeoJSON, {
                    style: getFeatureStyle,
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const sourceLayer = props.source_layer;

                        // Popup только для участков земли (polygons1)
                        if (sourceLayer === 'polygons1') {
                            let popupContent = '';
                            let hasData = false;

                            if (props.Field_Number) {
                                popupContent += `<div class="popup-info"><b>Номер:</b> ${props.Field_Number}</div>`;
                                hasData = true;
                            }
                            if (props['First and last name of the owners']) {
                                popupContent += `<div class="popup-info"><b>Владелец:</b> ${props['First and last name of the owners']}</div>`;
                                hasData = true;
                            }
                            if (props['Length of land plots']) {
                                popupContent += `<div class="popup-info"><b>Длина:</b> ${props['Length of land plots']}</div>`;
                                hasData = true;
                            }
                            if (props['Width of land plots']) {
                                popupContent += `<div class="popup-info"><b>Ширина:</b> ${props['Width of land plots']}</div>`;
                                hasData = true;
                            }

                            // Привязываем popup только если есть данные
                            if (hasData) {
                                layer.bindPopup(popupContent);
                            }

                            // Метка с номером участка
                            if (props.Field_Number) {
                                const center = layer.getBounds().getCenter();
                                const marker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'field-label',
                                        html: props.Field_Number,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                });

                                // Добавляем маркер в группу номеров
                                fieldLabelsGroup.addLayer(marker);
                            }

                            // Hover эффекты
                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // Для домов и частей участков - показываем popup участка под ними
                        if (sourceLayer === 'polygons2' || sourceLayer === 'polygons3') {
                            layer.on('click', function(e) {
                                // Ищем участок земли (polygons1) под кликом
                                const clickedPoint = e.latlng;

                                combinedLayer.eachLayer(function(l) {
                                    if (l.feature &&
                                        l.feature.properties.source_layer === 'polygons1' &&
                                        l.getBounds &&
                                        l.getBounds().contains(clickedPoint)) {

                                        // Если у участка есть popup, открываем его
                                        if (l.getPopup()) {
                                            l.openPopup(clickedPoint);
                                        }
                                    }
                                });
                            });
                        }

                        // Текст вдоль линии для улиц с названием
                        if (sourceLayer === 'lines' && props['Street name'] && props['Street name'] !== null && props['Street name'] !== '') {
                            layer.setText(props['Street name'], {
                                repeat: false,
                                center: true,
                                offset: -8,
                                attributes: {
                                    'class': 'leaflet-text-path',
                                    'dy': '-3'
                                }
                            });

                            // Сохраняем линию для управления видимостью названий
                            streetLayers.push(layer);
                        }
                    }
                }).addTo(map);

                console.log('✓ Единый слой создан и добавлен на карту');

                // Создаём группу, объединяющую историческую карту и номера участков
                const historicalMapGroup = L.layerGroup([combinedLayer, fieldLabelsGroup]).addTo(map);

                // Добавляем контроль слоёв (оба как checkbox'ы)
                const overlayMaps = {
                    "OpenStreetMap": osmLayer,
                    "Историческая карта 1888": historicalMapGroup
                };

                L.control.layers(null, overlayMaps, {
                    collapsed: false,
                    position: 'topright'
                }).addTo(map);

                // ========================================
                // УПРАВЛЕНИЕ ВИДИМОСТЬЮ НОМЕРОВ УЧАСТКОВ И НАЗВАНИЙ УЛИЦ
                // ========================================

                // Функция для обновления видимости номеров и названий улиц в зависимости от масштаба
                function updateLabelsVisibility() {
                    const zoom = map.getZoom();
                    const minZoom = 18; // Минимальный зоом для отображения надписей

                    // Скрываем/показываем номера участков
                    fieldLabelsGroup.eachLayer(marker => {
                        const element = marker.getElement();
                        if (element) {
                            if (zoom >= minZoom) {
                                element.classList.remove('field-label-hidden');
                            } else {
                                element.classList.add('field-label-hidden');
                            }
                        }
                    });

                    // Скрываем/показываем названия улиц
                    streetLayers.forEach(streetLayer => {
                        const pathElement = streetLayer._path;
                        if (pathElement) {
                            // Ищем текстовые элементы внутри SVG
                            const textElements = pathElement.parentElement.querySelectorAll('text.leaflet-text-path');
                            textElements.forEach(textElement => {
                                if (zoom >= minZoom) {
                                    textElement.classList.remove('leaflet-text-path-hidden');
                                } else {
                                    textElement.classList.add('leaflet-text-path-hidden');
                                }
                            });
                        }
                    });
                }

                // Вызываем при первой загрузке
                updateLabelsVisibility();

                // Обработчик изменения масштаба
                map.on('zoomend', updateLabelsVisibility);

                // ========================================
                // ЗАПОЛНЕНИЕ ТАБЛИЦЫ ДАННЫМИ
                // ========================================

                saveTableData(allFeatures);
                populateTable(allTableData);
            })
            .catch(error => {
                console.error('Ошибка загрузки слоёв:', error);
                alert('Не удалось загрузить данные карты. Проверьте наличие файлов в папке data/');
            });

            // ========================================
            // ФУНКЦИИ ДЛЯ РАБОТЫ С ТАБЛИЦЕЙ
            // ========================================

            function populateTable(features) {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = '';

                let rowCount = 0;

                features.forEach((feature, index) => {
                    const props = feature.properties;

                    const row = document.createElement('tr');
                    row.dataset.featureIndex = index;

                    // Номер участка
                    const displayNumber = props.Field_Number || '-';

                    // Владелец
                    let owner = '-';
                    if (props['First and last name of the owners']) {
                        owner = props['First and last name of the owners'];
                    }

                    // Длина
                    const length = props['Length of land plots'] || '-';

                    // Ширина
                    const width = props['Width of land plots'] || '-';

                    row.innerHTML = `
                        <td>${displayNumber}</td>
                        <td><span class="type-badge type-land">Участок</span></td>
                        <td>${owner}</td>
                        <td>${length}</td>
                        <td>${width}</td>
                    `;

                    tableBody.appendChild(row);
                    rowCount++;
                });

                console.log(`✓ Таблица заполнена: ${rowCount} записей`);

                // Обновляем заголовок с количеством записей
                document.getElementById('sidebar-header').textContent =
                    `База данных участков (${rowCount})`;
            }

            // ========================================
            // ПОИСК В ТАБЛИЦЕ
            // ========================================

            let allTableData = [];

            // Сохраняем данные для поиска
            function saveTableData(features) {
                allTableData = features.filter(feature => {
                    const sourceLayer = feature.properties.source_layer;
                    const props = feature.properties;

                    // Только участки земли (polygons1) с номером участка
                    return sourceLayer === 'polygons1' &&
                           props.Field_Number !== null &&
                           props.Field_Number !== undefined &&
                           props.Field_Number !== '';
                });
            }

            // Функция поиска
            function searchTable(searchTerm) {
                const term = searchTerm.toLowerCase().trim();

                if (term === '') {
                    // Показываем все данные
                    populateTable(allTableData);
                    return;
                }

                // Фильтруем данные
                const filtered = allTableData.filter(feature => {
                    const props = feature.properties;

                    // Поиск по номеру участка
                    const fieldNumber = String(props.Field_Number || '').toLowerCase();
                    if (fieldNumber.includes(term)) return true;

                    // Поиск по имени владельца
                    const owner = String(props['First and last name of the owners'] || '').toLowerCase();
                    if (owner.includes(term)) return true;

                    return false;
                });

                populateTable(filtered);
            }

            // Обработчик поиска (с задержкой для оптимизации)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTable(e.target.value);
                }, 300);
            });
            
            // ========================================
            // ЛЕГЕНДА
            // ========================================
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title">Легенда</div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#90EE90; border-color:#2d5f2d;"></span>
                        Участки земли
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFB6C1; border-color:#C71585;"></span>
                        Части участков
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFD700; border-color:#DAA520;"></span>
                        Дома
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#808080;"></span>
                        Границы улиц
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
            
            // ========================================
            // МАСШТАБ
            // ========================================
            
            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);
            
            console.log('🗺️ Карта инициализирована! Центр:', mapCenter, 'Zoom:', initialZoom);
        });
    </script>
</body>
</html>
