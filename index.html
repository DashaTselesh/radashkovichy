<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radashkovichy map 1888</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <style>
        /* ========================================
           RESET & BASE STYLES
           ======================================== */

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        /* ========================================
           LAYOUT
           ======================================== */

        #container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        #map {
            flex: 1;
            min-width: 50%;
            height: 100vh;
            background-color: #f0f0f0;
        }

        /* ========================================
           SIDEBAR
           ======================================== */

        #sidebar {
            width: 500px;
            height: 100vh;
            background: #f5f5f5;
            border-left: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar-header {
            background: #2c5f2d;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #sidebar-controls {
            padding: 10px 20px;
            background: white;
            border-bottom: 1px solid #ccc;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .filters-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .filter-label {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 4px;
            color: #555;
        }

        .filter-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .filter-input,
        .filter-select {
            padding: 6px 28px 6px 8px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            flex: 1;
        }

        .filter-select {
            cursor: pointer;
        }

        .clear-filter {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #999;
            font-size: 16px;
            padding: 2px 6px;
            display: none;
            background: transparent;
            border: none;
            line-height: 1;
        }

        .clear-filter:hover {
            color: #d32f2f;
        }

        .filter-wrapper.has-value .clear-filter {
            display: block;
        }

        /* Multiselect dropdown */
        .multiselect-dropdown {
            position: relative;
            width: 100%;
        }

        .multiselect-selected {
            padding: 6px 28px 6px 8px;
            font-size: 13px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            min-height: 30px;
            display: flex;
            align-items: center;
        }

        .multiselect-selected:hover {
            border-color: #999;
        }

        .multiselect-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-top: 2px;
            display: none;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .multiselect-options.show {
            display: block;
        }

        .multiselect-option {
            padding: 6px 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 13px;
        }

        .multiselect-option:hover {
            background: #f5f5f5;
        }

        .multiselect-option input[type="checkbox"] {
            margin-right: 8px;
        }

        .multiselect-placeholder {
            color: #999;
        }

        .multiselect-count {
            color: #2c5f2d;
            font-weight: bold;
        }

        #table-container {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        /* ========================================
           DATA TABLE
           ======================================== */

        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        /* Table Header */
        #data-table thead {
            position: sticky;
            top: 0;
            background: #2c5f2d;
            color: white;
            z-index: 10;
        }

        #data-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #1a3a1b;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        #data-table th:hover {
            background: #3a7a3d;
        }

        /* Sort Indicators */
        #data-table th[data-sort]::after {
            content: ' ⇅';
            opacity: 0.3;
            font-size: 12px;
            margin-left: 5px;
        }

        #data-table th.sort-asc::after {
            content: ' ▲';
            opacity: 1;
        }

        #data-table th.sort-desc::after {
            content: ' ▼';
            opacity: 1;
        }

        /* Table Cells */
        #data-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        /* Table Rows */
        #data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #data-table tbody tr:hover {
            background-color: #f0f8f0;
        }

        #data-table tbody tr.selected {
            background-color: #d4edda;
            font-weight: bold;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #data-table tbody tr:nth-child(even):hover {
            background-color: #f0f8f0;
        }

        /* ========================================
           MAP OVERLAYS
           ======================================== */

        /* Plot Number Labels */
        .field-label {
            background: transparent;
            border: none;
            padding: 0;
            font-size: 14px;
            font-weight: bold;
            color: #2c5f2d;
            text-align: center;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .field-label-hidden {
            opacity: 0;
        }

        /* Street Name Labels */
        .leaflet-text-path {
            font-size: 12px;
            font-weight: bold;
            fill: #333;
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: opacity 0.3s;
        }

        .leaflet-text-path-hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }

        /* Popup Content */
        .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }

        .popup-info {
            font-size: 13px;
            margin: 5px 0;
        }

        /* Map Legend */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 20px;
            font-size: 12px;
        }

        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .legend-item {
            margin: 3px 0;
        }

        .legend-color {
            display: inline-block;
            width: 20px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #333;
            vertical-align: middle;
        }

        /* ========================================
           MAP NAVIGATION CONTROL
           ======================================== */

        .map-navigation {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            margin-top: 10px;
        }

        .map-navigation-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 12px;
            color: #333;
        }

        .map-navigation-buttons {
            display: flex;
            gap: 5px;
        }

        .map-nav-btn {
            flex: 1;
            padding: 6px 10px;
            background: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            transition: all 0.2s;
            color: #333;
        }

        .map-nav-btn:hover {
            background: #2c5f2d;
            color: white;
            border-color: #2c5f2d;
        }

        .map-nav-btn.active {
            background: #2c5f2d;
            color: white;
            border-color: #2c5f2d;
        }

        /* ========================================
           LOADING STATE
           ======================================== */

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }

        /* ========================================
           RESPONSIVE DESIGN
           ======================================== */

        /* Tablets */
        @media (max-width: 1024px) {
            #sidebar {
                width: 400px;
            }
        }

        /* Mobile */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            #map {
                height: 50vh;
                min-width: 100%;
            }

            #sidebar {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 2px solid #ccc;
            }
        }
    </style>
</head>
<body>
    <div id="loading">Map loading...</div>

    <div id="container">
        <div id="map"></div>

        <div id="sidebar">
            <div id="sidebar-header">
                Land Plots Database
            </div>

            <div id="sidebar-controls">
                <input type="text" id="search-input" placeholder="Search by plot number or owner...">

                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Owner Name:</label>
                        <div class="filter-wrapper" id="owner-filter-wrapper">
                            <input type="text" id="filter-owner" class="filter-input" placeholder="Filter by owner...">
                            <button class="clear-filter" id="clear-owner" title="Clear filter">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">Plan Part:</label>
                        <div class="filter-wrapper">
                            <div class="multiselect-dropdown" id="planpart-multiselect">
                                <div class="multiselect-selected">
                                    <span class="multiselect-placeholder">Select Plan Parts...</span>
                                </div>
                                <div class="multiselect-options"></div>
                            </div>
                            <button class="clear-filter" id="clear-planpart" title="Clear selection" style="display: none;">×</button>
                        </div>
                    </div>
                </div>

                <div class="filters-row">
                    <div class="filter-group">
                        <label class="filter-label">Map:</label>
                        <select id="filter-map" class="filter-select" style="padding: 6px 8px;">
                            <option value="">All Maps</option>
                            <option value="map1">Map 1</option>
                            <option value="map2">Map 2</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th data-sort="number">No.</th>
                            <th data-sort="owner">Owner Name (translit)</th>
                            <th data-sort="ownernative">Owner Name (native)</th>
                            <th data-sort="planpart">Plan part</th>
                            <th data-sort="length">Length</th>
                            <th data-sort="width">Width</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- Data will be loaded via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet TextPath Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js"></script>
    
    <script>
        // ========================================
        // APPLICATION INITIALIZATION
        // ========================================

        window.addEventListener('load', function() {
            // Hide loading indicator
            document.getElementById('loading').style.display = 'none';

            // Check if Leaflet is loaded
            if (typeof L === 'undefined') {
                alert('Error: The library Leaflet was not loaded. Check your internet connection.');
                return;
            }

            // ========================================
            // MAP CONFIGURATION
            // ========================================

            const mapCenter = [54.158000, 27.237500]; // Center between both maps
            const initialZoom = 16;
            const minZoomForLabels = 18; // Minimum zoom level to show labels
            
            // ========================================
            // MAP INITIALIZATION
            // ========================================

            const map = L.map('map').setView(mapCenter, initialZoom);

            // OpenStreetMap base layer
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 22,
                maxNativeZoom: 19
            }).addTo(map);

            // ========================================
            // LAYER STYLING FUNCTIONS
            // ========================================

            // Determine feature style based on source layer
            function getFeatureStyle(feature) {
                const sourceLayer = feature.properties.source_layer;
                const props = feature.properties;

                // Street boundaries (lines)
                if (sourceLayer === 'lines') {
                    return {
                        color: props.stroke_color || '#808080',
                        weight: props.stroke_width || 2,
                        opacity: 1,
                        dashArray: props.dash_array || ''
                    };
                }

                // Land plots (polygons1)
                if (sourceLayer === 'polygons1') {
                    return {
                        fillColor: props.fill_color || '#90EE90',
                        fillOpacity: props.fill_opacity || 0.8,
                        color: props.stroke_color || '#2d5f2d',
                        weight: props.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Plot subdivisions (polygons2)
                if (sourceLayer === 'polygons2') {
                    return {
                        fillColor: props.fill_color || '#FFB6C1',
                        fillOpacity: props.fill_opacity || 0.8,
                        color: props.stroke_color || '#C71585',
                        weight: props.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Buildings (polygons3)
                if (sourceLayer === 'polygons3') {
                    return {
                        fillColor: props.fill_color || '#FFD700',
                        fillOpacity: props.fill_opacity || 0.8,
                        color: props.stroke_color || '#DAA520',
                        weight: props.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Map 2 land plots (map2-polygons1)
                if (sourceLayer === 'map2-polygons1') {
                    return {
                        fillColor: props.fill_color || '#90EE90',
                        fillOpacity: props.fill_opacity || 0.8,
                        color: props.stroke_color || '#2d5f2d',
                        weight: props.stroke_width || 2,
                        opacity: 1
                    };
                }

                // Default style
                return {
                    fillColor: '#cccccc',
                    fillOpacity: 0.5,
                    color: '#666666',
                    weight: 2,
                    opacity: 1
                };
            }

            // ========================================
            // GLOBAL LAYER VARIABLES
            // ========================================

            let combinedLayer; // Combined GeoJSON layer with all features
            let map2Layer; // Map 2 GeoJSON layer
            let fieldLabelsGroup = L.layerGroup(); // Group for plot number markers for map1
            let map2LabelsGroup = L.layerGroup(); // Group for plot number markers for map2
            let streetLayers = []; // Array to store street lines with names

            // ========================================
            // DATA LOADING
            // ========================================

            // Load all GeoJSON files in parallel
            Promise.all([
                fetch('data/map1-polygons.geojson').then(r => r.json()),
                fetch('data/map1-buildings.geojson').then(r => r.json()),
                fetch('data/map1-buildings2.geojson').then(r => r.json()),
                fetch('data/map1-lines.geojson').then(r => r.json()),
                fetch('data/map2-polygons.geojson').then(r => r.json())
            ])
            .then(([polygons1Data, polygons3Data, polygons2Data, linesData, map2PolygonsData]) => {
                console.log('✓ All files loaded');

                // Tag each feature with its source layer for proper styling
                polygons1Data.features.forEach(f => f.properties.source_layer = 'polygons1');
                polygons2Data.features.forEach(f => f.properties.source_layer = 'polygons2');
                polygons3Data.features.forEach(f => f.properties.source_layer = 'polygons3');
                linesData.features.forEach(f => f.properties.source_layer = 'lines');
                map2PolygonsData.features.forEach(f => f.properties.source_layer = 'map2-polygons1');

                // Combine all features into a single array
                const allFeatures = [
                    ...polygons1Data.features,
                    ...polygons2Data.features,
                    ...polygons3Data.features,
                    ...linesData.features
                ];

                // Sort by layer_order (features without layer_order go last)
                allFeatures.sort((a, b) => {
                    const orderA = a.properties.layer_order !== undefined ? a.properties.layer_order : Infinity;
                    const orderB = b.properties.layer_order !== undefined ? b.properties.layer_order : Infinity;
                    return orderA - orderB;
                });

                console.log(`✓ Sorted ${allFeatures.length} features by layer_order`);

                // Create combined GeoJSON object
                const combinedGeoJSON = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };

                // ========================================
                // CREATE COMBINED LAYER
                // ========================================

                combinedLayer = L.geoJSON(combinedGeoJSON, {
                    style: getFeatureStyle,
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const sourceLayer = props.source_layer;

                        // Configure popups and interactions for land plots
                        if (sourceLayer === 'polygons1') {
                            let popupContent = '';
                            let hasData = false;

                            if (props.Field_Number) {
                                popupContent += `<div class="popup-info"><b>Number:</b> ${props.Field_Number}</div>`;
                                hasData = true;
                            }
                            if (props['First and last name of the owners']) {
                                popupContent += `<div class="popup-info"><b>Owner Name (translit):</b> ${props['First and last name of the owners']}</div>`;
                                hasData = true;
                            }
                            if (props['Length of land plots']) {
                                popupContent += `<div class="popup-info"><b>Length:</b> ${props['Length of land plots']}</div>`;
                                hasData = true;
                            }
                            if (props['Width of land plots']) {
                                popupContent += `<div class="popup-info"><b>Width:</b> ${props['Width of land plots']}</div>`;
                                hasData = true;
                            }

                            // Bind popup only if there is data
                            if (hasData) {
                                layer.bindPopup(popupContent);

                                // Add event listener for when popup opens
                                layer.on('popupopen', function() {
                                    // Highlight corresponding row in table
                                    document.querySelectorAll('#data-table tbody tr.selected').forEach(row => {
                                        row.classList.remove('selected');
                                    });
                                    document.querySelectorAll('#data-table tbody tr').forEach(row => {
                                        if (row.dataset.fid == props.fid) {
                                            row.classList.add('selected');
                                            // Scroll row into view
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }
                                    });
                                });
                            }

                            // Create plot number marker
                            if (props.Field_Number) {
                                const center = layer.getBounds().getCenter();
                                const marker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'field-label',
                                        html: props.Field_Number,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                });

                                // Click on marker opens popup from parent polygon
                                marker.on('click', function(e) {
                                    if (layer.getPopup()) {
                                        layer.openPopup(e.latlng);
                                    }
                                });

                                // Add marker to plot numbers group
                                fieldLabelsGroup.addLayer(marker);
                            }

                            // Hover effects for land plots
                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // Buildings and subdivisions: show popup from underlying land plot
                        if (sourceLayer === 'polygons2' || sourceLayer === 'polygons3') {
                            layer.on('click', function(e) {
                                const clickedPoint = e.latlng;

                                // Find land plot (polygons1) under the clicked point
                                combinedLayer.eachLayer(function(l) {
                                    if (l.feature &&
                                        l.feature.properties.source_layer === 'polygons1' &&
                                        l.getBounds &&
                                        l.getBounds().contains(clickedPoint)) {

                                        if (l.getPopup()) {
                                            l.openPopup(clickedPoint);
                                        }
                                    }
                                });
                            });
                        }

                        // Street names along lines
                        if (sourceLayer === 'lines' && props['Street name'] && props['Street name'] !== null && props['Street name'] !== '') {
                            // Store street name for later use
                            layer._streetName = props['Street name'];

                            layer.setText(props['Street name'], {
                                repeat: false,
                                center: true,
                                offset: -8,
                                attributes: {
                                    'class': 'leaflet-text-path',
                                    'dy': '-3'
                                }
                            });

                            // Store for visibility management
                            streetLayers.push(layer);
                        }
                    }
                }).addTo(map);

                console.log('✓ Combined layer created and added to map');

                // ========================================
                // CREATE MAP 2 LAYER
                // ========================================

                map2Layer = L.geoJSON(map2PolygonsData, {
                    style: getFeatureStyle,
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const sourceLayer = props.source_layer;

                        // Configure popups and interactions for map2 land plots
                        if (sourceLayer === 'map2-polygons1') {
                            let popupContent = '';
                            let hasData = false;

                            if (props.Number) {
                                popupContent += `<div class="popup-info"><b>Number:</b> ${props.Number}</div>`;
                                hasData = true;
                            }
                            if (props['Name translit']) {
                                popupContent += `<div class="popup-info"><b>Owner Name (translit):</b> ${props['Name translit']}</div>`;
                                hasData = true;
                            }
                            if (props['Name native']) {
                                popupContent += `<div class="popup-info"><b>Owner Name (native):</b> ${props['Name native']}</div>`;
                                hasData = true;
                            }
                            if (props.Length) {
                                popupContent += `<div class="popup-info"><b>Length:</b> ${props.Length}</div>`;
                                hasData = true;
                            }
                            if (props.Width) {
                                popupContent += `<div class="popup-info"><b>Width:</b> ${props.Width}</div>`;
                                hasData = true;
                            }

                            // Bind popup only if there is data
                            if (hasData) {
                                layer.bindPopup(popupContent);

                                // Add event listener for when popup opens
                                layer.on('popupopen', function() {
                                    // Highlight corresponding row in table
                                    document.querySelectorAll('#data-table tbody tr.selected').forEach(row => {
                                        row.classList.remove('selected');
                                    });
                                    document.querySelectorAll('#data-table tbody tr').forEach(row => {
                                        if (row.dataset.fid == props.fid) {
                                            row.classList.add('selected');
                                            // Scroll row into view
                                            row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }
                                    });
                                });
                            }

                            // Create plot number marker
                            if (props.Number) {
                                const center = layer.getBounds().getCenter();
                                const marker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'field-label',
                                        html: props.Number,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                });

                                // Click on marker opens popup from parent polygon
                                marker.on('click', function(e) {
                                    if (layer.getPopup()) {
                                        layer.openPopup(e.latlng);
                                    }
                                });

                                // Add marker to map2 plot numbers group
                                map2LabelsGroup.addLayer(marker);
                            }

                            // Hover effects for land plots
                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                map2Layer.resetStyle(layer);
                            });
                        }
                    }
                });

                console.log('✓ Map 2 layer created');

                // Create group combining historical map and plot numbers
                const historicalMapGroup = L.layerGroup([combinedLayer, fieldLabelsGroup]).addTo(map);
                const map2Group = L.layerGroup([map2Layer, map2LabelsGroup]).addTo(map);

                // Add layer control (both as checkboxes)
                const overlayMaps = {
                    "OpenStreetMap": osmLayer,
                    "Historical Map 1888": historicalMapGroup,
                    "Map 2": map2Group
                };

                L.control.layers(null, overlayMaps, {
                    collapsed: false,
                    position: 'topright'
                }).addTo(map);

                // ========================================
                // MAP NAVIGATION CONTROL
                // ========================================

                // Define map centers and zoom levels
                const map1Center = [54.154854, 27.240569]; // Map 1 center
                const map2Center = [54.161500, 27.235000]; // Map 2 center
                const navigationZoom = 18;

                // Create custom navigation control
                const MapNavigationControl = L.Control.extend({
                    options: {
                        position: 'topright'
                    },

                    onAdd: function(map) {
                        const container = L.DomUtil.create('div', 'leaflet-bar map-navigation');

                        container.innerHTML = `
                            <div class="map-navigation-title">Quick View:</div>
                            <div class="map-navigation-buttons">
                                <button class="map-nav-btn" data-view="map1">Map 1</button>
                                <button class="map-nav-btn" data-view="map2">Map 2</button>
                            </div>
                        `;

                        // Prevent map interactions when clicking on navigation
                        L.DomEvent.disableClickPropagation(container);
                        L.DomEvent.disableScrollPropagation(container);

                        return container;
                    }
                });

                const mapNavigation = new MapNavigationControl();
                mapNavigation.addTo(map);

                // Add click handlers for navigation buttons
                document.querySelectorAll('.map-nav-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const view = this.getAttribute('data-view');

                        // Remove active class from all buttons
                        document.querySelectorAll('.map-nav-btn').forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        this.classList.add('active');

                        // Handle view switching
                        if (view === 'map1') {
                            // Ensure Map 1 layer is visible
                            if (!map.hasLayer(historicalMapGroup)) {
                                map.addLayer(historicalMapGroup);
                            }
                            // Fly to Map 1 center
                            map.flyTo(map1Center, navigationZoom, {
                                duration: 1.5,
                                easeLinearity: 0.5
                            });
                        } else if (view === 'map2') {
                            // Ensure Map 2 layer is visible
                            if (!map.hasLayer(map2Group)) {
                                map.addLayer(map2Group);
                            }
                            // Fly to Map 2 center
                            map.flyTo(map2Center, navigationZoom, {
                                duration: 1.5,
                                easeLinearity: 0.5
                            });
                        }
                    });
                });

                // ========================================
                // LABEL VISIBILITY MANAGEMENT
                // ========================================

                // Update visibility of plot numbers and street names based on zoom level
                function updateLabelsVisibility() {
                    const zoom = map.getZoom();

                    // Toggle plot number visibility for map1
                    fieldLabelsGroup.eachLayer(marker => {
                        const element = marker.getElement();
                        if (element) {
                            if (zoom >= minZoomForLabels) {
                                element.classList.remove('field-label-hidden');
                            } else {
                                element.classList.add('field-label-hidden');
                            }
                        }
                    });

                    // Toggle plot number visibility for map2
                    map2LabelsGroup.eachLayer(marker => {
                        const element = marker.getElement();
                        if (element) {
                            if (zoom >= minZoomForLabels) {
                                element.classList.remove('field-label-hidden');
                            } else {
                                element.classList.add('field-label-hidden');
                            }
                        }
                    });

                    // Toggle street name visibility via CSS class
                    const allTextElements = document.querySelectorAll('text.leaflet-text-path');
                    allTextElements.forEach(el => {
                        if (zoom >= minZoomForLabels) {
                            el.classList.remove('leaflet-text-path-hidden');
                        } else {
                            el.classList.add('leaflet-text-path-hidden');
                        }
                    });
                }

                // Initialize label visibility
                updateLabelsVisibility();

                // Update on zoom and move events
                // moveend is needed because leaflet-textpath plugin redraws text on map pan
                map.on('zoomend moveend', updateLabelsVisibility);

                // ========================================
                // POPULATE TABLE
                // ========================================

                saveTableData(allFeatures, map2PolygonsData.features);
                populateTable(allTableData);
            })
            .catch(error => {
                console.error('Error loading layers:', error);
                alert('Failed to load map data. Please check that files exist in the data/ folder.');
            });

            // ========================================
            // TABLE POPULATION FUNCTIONS
            // ========================================

            // Populate table with feature data
            function populateTable(features) {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = '';

                let rowCount = 0;

                features.forEach((feature, index) => {
                    const props = feature.properties;
                    const isMap2 = props.source_layer === 'map2-polygons1';

                    const row = document.createElement('tr');
                    row.dataset.featureIndex = index;
                    row.dataset.fid = props.fid; // Unique feature ID for lookup
                    row.dataset.sourceLayer = props.source_layer; // Store source layer for lookup

                    // Extract data based on source
                    const displayNumber = isMap2 ? (props.Number || '-') : (props.Field_Number || '-');
                    const owner = isMap2
                        ? (props['Name translit'] || props['Name native'] || '-')
                        : (props['First and last name of the owners'] || '-');
                    const ownerNative = isMap2 ? (props['Name native'] || '-') : '-';
                    const planPart = isMap2 ? (props['Plan part'] || '-') : '-';
                    const length = isMap2 ? (props.Length || '-') : (props['Length of land plots'] || '-');
                    const width = isMap2 ? (props.Width || '-') : (props['Width of land plots'] || '-');

                    row.innerHTML = `
                        <td>${displayNumber}</td>
                        <td>${owner}</td>
                        <td>${ownerNative}</td>
                        <td>${planPart}</td>
                        <td>${length}</td>
                        <td>${width}</td>
                    `;

                    // Click row to open popup on map
                    row.addEventListener('click', function() {
                        openPopupForPlot(this.dataset.fid, this.dataset.sourceLayer);
                    });

                    tableBody.appendChild(row);
                    rowCount++;
                });

                console.log(`✓ Table populated: ${rowCount} entries`);

                // Update header with count
                document.getElementById('sidebar-header').textContent =
                    `Land Plots Database (${rowCount})`;
            }

            // Open popup for a specific plot on the map (called from table row click)
            function openPopupForPlot(fid, sourceLayer) {
                // Clear previous table selection
                document.querySelectorAll('#data-table tbody tr.selected').forEach(row => {
                    row.classList.remove('selected');
                });

                // Highlight selected row
                document.querySelectorAll('#data-table tbody tr').forEach(row => {
                    if (row.dataset.fid == fid) {
                        row.classList.add('selected');
                    }
                });

                // Determine which layer to search based on sourceLayer
                const targetLayer = sourceLayer === 'map2-polygons1' ? map2Layer : combinedLayer;
                const targetSourceLayer = sourceLayer === 'map2-polygons1' ? 'map2-polygons1' : 'polygons1';

                if (!targetLayer) return;

                // Find layer by unique feature ID
                targetLayer.eachLayer(function(layer) {
                    if (layer.feature &&
                        layer.feature.properties.source_layer === targetSourceLayer &&
                        layer.feature.properties.fid == fid) {

                        const center = layer.getBounds().getCenter();

                        // Pan and zoom to plot
                        map.setView(center, Math.max(map.getZoom(), 18));

                        // Open popup
                        if (layer.getPopup()) {
                            layer.openPopup();
                        }
                    }
                });
            }

            // ========================================
            // SEARCH AND SORT IN TABLE
            // ========================================

            let allTableData = [];
            let currentSortColumn = 'number'; // Default sort by plot number
            let currentSortDirection = 'asc'; // ascending

            // Save data for search and sort
            function saveTableData(features, map2Features) {
                // Filter map1 features (polygons1) with plot number
                const map1Data = features.filter(feature => {
                    const sourceLayer = feature.properties.source_layer;
                    const props = feature.properties;

                    return sourceLayer === 'polygons1' &&
                           props.Field_Number !== null &&
                           props.Field_Number !== undefined &&
                           props.Field_Number !== '';
                });

                // Filter map2 features with Number field
                const map2Data = map2Features.filter(feature => {
                    const props = feature.properties;
                    return props.Number !== null &&
                           props.Number !== undefined &&
                           props.Number !== '';
                });

                // Combine both datasets
                allTableData = [...map1Data, ...map2Data];

                // Populate Plan part filter options
                populatePlanPartFilter();

                // Apply default sorting by number
                sortTableData('number', 'asc');
            }

            // Track selected plan parts
            let selectedPlanParts = new Set();

            // Populate Plan part multiselect with unique values
            function populatePlanPartFilter() {
                const uniquePlanParts = new Set();

                // Collect unique Plan part values from map2 data
                allTableData.forEach(feature => {
                    const props = feature.properties;
                    const isMap2 = props.source_layer === 'map2-polygons1';

                    if (isMap2 && props['Plan part']) {
                        uniquePlanParts.add(props['Plan part']);
                    }
                });

                // Get the options container
                const optionsContainer = document.querySelector('#planpart-multiselect .multiselect-options');
                optionsContainer.innerHTML = '';

                // Add checkboxes for each unique plan part
                Array.from(uniquePlanParts).sort().forEach(planPart => {
                    const option = document.createElement('div');
                    option.className = 'multiselect-option';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = planPart;
                    checkbox.id = `planpart-${planPart}`;

                    const label = document.createElement('label');
                    label.textContent = planPart;
                    label.htmlFor = `planpart-${planPart}`;
                    label.style.cursor = 'pointer';
                    label.style.flex = '1';

                    option.appendChild(checkbox);
                    option.appendChild(label);

                    // Handle checkbox change
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedPlanParts.add(this.value);
                        } else {
                            selectedPlanParts.delete(this.value);
                        }
                        updatePlanPartDisplay();
                        applyFilters();
                    });

                    optionsContainer.appendChild(option);
                });

                // Initialize display
                updatePlanPartDisplay();
            }

            // Update the multiselect display text
            function updatePlanPartDisplay() {
                const selectedDiv = document.querySelector('#planpart-multiselect .multiselect-selected');
                const clearButton = document.getElementById('clear-planpart');

                if (selectedPlanParts.size === 0) {
                    selectedDiv.innerHTML = '<span class="multiselect-placeholder">Select Plan Parts...</span>';
                    clearButton.style.display = 'none';
                } else {
                    selectedDiv.innerHTML = `<span class="multiselect-count">${selectedPlanParts.size} selected</span>`;
                    clearButton.style.display = 'block';
                }
            }

            // Toggle multiselect dropdown
            document.addEventListener('click', function(e) {
                const multiselect = document.getElementById('planpart-multiselect');
                const selected = multiselect.querySelector('.multiselect-selected');
                const options = multiselect.querySelector('.multiselect-options');

                if (selected.contains(e.target)) {
                    options.classList.toggle('show');
                } else if (!multiselect.contains(e.target)) {
                    options.classList.remove('show');
                }
            });

            // Sort table data
            function sortTableData(column, direction) {
                allTableData.sort((a, b) => {
                    let valueA, valueB;
                    const propsA = a.properties;
                    const propsB = b.properties;
                    const isMap2A = propsA.source_layer === 'map2-polygons1';
                    const isMap2B = propsB.source_layer === 'map2-polygons1';

                    switch(column) {
                        case 'number':
                            valueA = parseInt(isMap2A ? propsA.Number : propsA.Field_Number) || 0;
                            valueB = parseInt(isMap2B ? propsB.Number : propsB.Field_Number) || 0;
                            break;
                        case 'owner':
                            if (isMap2A) {
                                valueA = (propsA['Name translit'] || propsA['Name native'] || '').toLowerCase();
                            } else {
                                valueA = (propsA['First and last name of the owners'] || '').toLowerCase();
                            }
                            if (isMap2B) {
                                valueB = (propsB['Name translit'] || propsB['Name native'] || '').toLowerCase();
                            } else {
                                valueB = (propsB['First and last name of the owners'] || '').toLowerCase();
                            }
                            break;
                        case 'ownernative':
                            valueA = isMap2A ? (propsA['Name native'] || '').toLowerCase() : '';
                            valueB = isMap2B ? (propsB['Name native'] || '').toLowerCase() : '';
                            break;
                        case 'planpart':
                            valueA = isMap2A ? (propsA['Plan part'] || '').toLowerCase() : '';
                            valueB = isMap2B ? (propsB['Plan part'] || '').toLowerCase() : '';
                            break;
                        case 'length':
                            valueA = parseFloat(isMap2A ? propsA.Length : propsA['Length of land plots']) || 0;
                            valueB = parseFloat(isMap2B ? propsB.Length : propsB['Length of land plots']) || 0;
                            break;
                        case 'width':
                            valueA = parseFloat(isMap2A ? propsA.Width : propsA['Width of land plots']) || 0;
                            valueB = parseFloat(isMap2B ? propsB.Width : propsB['Width of land plots']) || 0;
                            break;
                        default:
                            return 0;
                    }

                    if (valueA < valueB) return direction === 'asc' ? -1 : 1;
                    if (valueA > valueB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // Handle column header click for sorting
            function handleSort(column) {
                // Toggle direction if clicking the same column
                if (currentSortColumn === column) {
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSortColumn = column;
                    currentSortDirection = 'asc';
                }

                sortTableData(currentSortColumn, currentSortDirection);

                // Re-apply all filters after sorting
                applyFilters();

                // Update visual indicators
                updateSortIndicators();
            }

            // Update sort indicators in table headers
            function updateSortIndicators() {
                document.querySelectorAll('#data-table th').forEach(th => {
                    th.classList.remove('sort-asc', 'sort-desc');
                    const sortColumn = th.getAttribute('data-sort');
                    if (sortColumn === currentSortColumn) {
                        th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                    }
                });
            }

            // Apply all filters (search + owner + plan part + map)
            function applyFilters() {
                // Get all filter values
                const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                const ownerFilter = document.getElementById('filter-owner').value.toLowerCase().trim();
                const mapFilter = document.getElementById('filter-map').value;

                // Update clear button visibility
                updateClearButtonVisibility();

                // Filter data
                const filtered = allTableData.filter(feature => {
                    const props = feature.properties;
                    const isMap2 = props.source_layer === 'map2-polygons1';

                    // Filter by map number
                    if (mapFilter !== '') {
                        if (mapFilter === 'map1' && isMap2) return false;
                        if (mapFilter === 'map2' && !isMap2) return false;
                    }

                    // Filter by search term (plot number or owner)
                    if (searchTerm !== '') {
                        let matchesSearch = false;

                        // Check plot number
                        const fieldNumber = String(isMap2 ? (props.Number || '') : (props.Field_Number || '')).toLowerCase();
                        if (fieldNumber.includes(searchTerm)) matchesSearch = true;

                        // Check owner name (translit)
                        const owner = isMap2
                            ? String(props['Name translit'] || props['Name native'] || '').toLowerCase()
                            : String(props['First and last name of the owners'] || '').toLowerCase();
                        if (owner.includes(searchTerm)) matchesSearch = true;

                        // Check owner name (native)
                        if (isMap2) {
                            const ownerNative = String(props['Name native'] || '').toLowerCase();
                            if (ownerNative.includes(searchTerm)) matchesSearch = true;
                        }

                        // Check plan part
                        if (isMap2) {
                            const planPart = String(props['Plan part'] || '').toLowerCase();
                            if (planPart.includes(searchTerm)) matchesSearch = true;
                        }

                        if (!matchesSearch) return false;
                    }

                    // Filter by owner name
                    if (ownerFilter !== '') {
                        let matchesOwner = false;

                        if (isMap2) {
                            // For Map2, check both translit AND native fields
                            const ownerTranslit = String(props['Name translit'] || '').toLowerCase();
                            const ownerNative = String(props['Name native'] || '').toLowerCase();

                            if (ownerTranslit.includes(ownerFilter) || ownerNative.includes(ownerFilter)) {
                                matchesOwner = true;
                            }
                        } else {
                            // For Map1, check the owner field
                            const owner = String(props['First and last name of the owners'] || '').toLowerCase();
                            if (owner.includes(ownerFilter)) {
                                matchesOwner = true;
                            }
                        }

                        if (!matchesOwner) return false;
                    }

                    // Filter by plan part (multiselect)
                    if (selectedPlanParts.size > 0) {
                        if (!isMap2) return false; // Plan part only exists in map2
                        const planPart = String(props['Plan part'] || '');
                        if (!selectedPlanParts.has(planPart)) return false;
                    }

                    return true;
                });

                populateTable(filtered);
            }

            // Deprecated: kept for compatibility
            function searchTable(searchTerm) {
                applyFilters();
            }

            // Search handler (with delay for optimization)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });

            // Owner filter handler
            let ownerFilterTimeout;
            document.getElementById('filter-owner').addEventListener('input', function(e) {
                clearTimeout(ownerFilterTimeout);
                ownerFilterTimeout = setTimeout(() => {
                    applyFilters();
                }, 300);
            });

            // Map filter handler
            document.getElementById('filter-map').addEventListener('change', function(e) {
                applyFilters();
            });

            // Update clear button visibility based on filter values
            function updateClearButtonVisibility() {
                const ownerInput = document.getElementById('filter-owner');
                const ownerWrapper = document.getElementById('owner-filter-wrapper');
                if (ownerInput.value.trim() !== '') {
                    ownerWrapper.classList.add('has-value');
                } else {
                    ownerWrapper.classList.remove('has-value');
                }
            }

            // Clear owner filter
            document.getElementById('clear-owner').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('filter-owner').value = '';
                updateClearButtonVisibility();
                applyFilters();
            });

            // Clear plan part filter
            document.getElementById('clear-planpart').addEventListener('click', function(e) {
                e.stopPropagation();
                // Uncheck all checkboxes
                selectedPlanParts.clear();
                document.querySelectorAll('#planpart-multiselect input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                updatePlanPartDisplay();
                applyFilters();
            });

            // Add click handlers to table headers for sorting
            document.querySelectorAll('#data-table th[data-sort]').forEach(th => {
                th.addEventListener('click', function() {
                    const column = this.getAttribute('data-sort');
                    handleSort(column);
                });
            });

            // Initialize sort indicators
            updateSortIndicators();
            
            // ========================================
            // MAP LEGEND
            // ========================================

            const legend = L.control({position: 'bottomleft'});

            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title">Legend</div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#90EE90; border-color:#2d5f2d;"></span>
                        Land plots (Map 1)
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFB6C1; border-color:#C71585;"></span>
                        Plot subdivisions
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFD700; border-color:#DAA520;"></span>
                        Buildings
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#808080;"></span>
                        Street boundaries
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#90EE90; border-color:#2d5f2d;"></span>
                        Land plots (Map 2)
                    </div>
                `;
                return div;
            };

            legend.addTo(map);

            // ========================================
            // MAP SCALE
            // ========================================

            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);

            console.log('🗺️ Map initialized! Center:', mapCenter, 'Zoom:', initialZoom);
        });
    </script>
</body>
</html>
