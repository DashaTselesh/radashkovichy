<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radashkovichy map 1888</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>

    <!-- Leaflet TextPath CSS -->
    <style>
        .leaflet-text-path {
            font-size: 12px;
            font-weight: bold;
            fill: #333;
            paint-order: stroke;
            stroke: white;
            stroke-width: 3px;
            stroke-linecap: round;
            stroke-linejoin: round;
            transition: opacity 0.3s;
        }

        .leaflet-text-path-hidden {
            opacity: 0;
        }
    </style>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        #container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        #map {
            flex: 1;
            min-width: 50%;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #sidebar {
            width: 500px;
            height: 100vh;
            background: #f5f5f5;
            border-left: 2px solid #ccc;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebar-header {
            background: #2c5f2d;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }

        #sidebar-controls {
            padding: 10px 20px;
            background: white;
            border-bottom: 1px solid #ccc;
        }

        #search-input {
            width: 100%;
            padding: 8px 12px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        #table-container {
            flex: 1;
            overflow-y: auto;
            background: white;
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        #data-table thead {
            position: sticky;
            top: 0;
            background: #2c5f2d;
            color: white;
            z-index: 10;
        }

        #data-table th {
            padding: 10px 8px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #1a3a1b;
            cursor: pointer;
            user-select: none;
        }

        #data-table th:hover {
            background: #3a7a3d;
        }

        #data-table td {
            padding: 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        #data-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #data-table tbody tr:hover {
            background-color: #f0f8f0;
        }

        #data-table tbody tr.selected {
            background-color: #d4edda;
            font-weight: bold;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #fafafa;
        }

        #data-table tbody tr:nth-child(even):hover {
            background-color: #f0f8f0;
        }

        .type-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }

        .type-land {
            background: #90EE90;
            color: #2d5f2d;
        }

        .type-building {
            background: #FFD700;
            color: #8B6914;
        }

        .type-subdivision {
            background: #FFB6C1;
            color: #8B2252;
        }

        .type-street {
            background: #808080;
            color: white;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
        @media (max-width: 1024px) {
            #sidebar {
                width: 400px;
            }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        @media (max-width: 768px) {
            #container {
                flex-direction: column;
            }

            #map {
                height: 50vh;
                min-width: 100%;
            }

            #sidebar {
                width: 100%;
                height: 50vh;
                border-left: none;
                border-top: 2px solid #ccc;
            }
        }
        
        /* Plot numbers */
        .field-label {
            background: transparent;
            border: none;
            padding: 0;
            font-size: 14px;
            font-weight: bold;
            color: #2c5f2d;
            text-align: center;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .field-label-hidden {
            opacity: 0;
        }
        
        /* Popup */
        .leaflet-popup-content {
            margin: 10px;
            line-height: 1.4;
        }

        .popup-info {
            font-size: 13px;
            margin: 5px 0;
        }
        
        /* Legend */
        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            line-height: 20px;
            font-size: 12px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .legend-item {
            margin: 3px 0;
        }
        
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 15px;
            margin-right: 5px;
            border: 1px solid #333;
            vertical-align: middle;
        }
        
        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }
    </style>
</head>
<body>
    <div id="loading">Map loading...</div>

    <div id="container">
        <div id="map"></div>

        <div id="sidebar">
            <div id="sidebar-header">
                –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤
            </div>

            <div id="sidebar-controls">
                <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —É—á–∞—Å—Ç–∫–∞ –∏–ª–∏ –≤–ª–∞–¥–µ–ª—å—Ü—É...">
            </div>

            <div id="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th data-sort="number">‚Ññ</th>
                            <th data-sort="type">–¢–∏–ø</th>
                            <th data-sort="owner">–í–ª–∞–¥–µ–ª–µ—Ü</th>
                            <th data-sort="length">–î–ª–∏–Ω–∞</th>
                            <th data-sort="width">–®–∏—Ä–∏–Ω–∞</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Leaflet JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>

    <!-- Leaflet TextPath Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.3/leaflet.textpath.min.js"></script>
    
    <script>
        // –ñ–¥—ë–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('load', function() {
            // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            document.getElementById('loading').style.display = 'none';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ Leaflet –∑–∞–≥—Ä—É–∂–µ–Ω
            if (typeof L === 'undefined') {
                alert('Error: The library Leaflet was not loaded. Check your internet connection.');
                return;
            }
            
            // ========================================
            // –ù–ê–°–¢–†–û–ô–ö–ò –ö–ê–†–¢–´
            // ========================================
            
            // –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–ò –ö–û–û–†–î–ò–ù–ê–¢–´ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ!
            // –§–æ—Ä–º–∞—Ç: [—à–∏—Ä–æ—Ç–∞, –¥–æ–ª–≥–æ—Ç–∞] –≤ –≥—Ä–∞–¥—É—Å–∞—Ö (WGS84)
            const mapCenter = [54.154854, 27.240569]; 
            const initialZoom = 18;
            
            // ========================================
            // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–†–¢–´
            // ========================================
            
            const map = L.map('map').setView(mapCenter, initialZoom);

            // –ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–∞ OpenStreetMap
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 22,
                maxNativeZoom: 19
            }).addTo(map);
            
            // ========================================
            // –°–¢–ò–õ–ò –î–õ–Ø –°–õ–û–Å–í
            // ========================================

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ñ–∏—á–∏ –ø–æ –∏—Å—Ö–æ–¥–Ω–æ–º—É —Å–ª–æ—é
            function getFeatureStyle(feature) {
                const sourceLayer = feature.properties.source_layer;

                // –î–ª—è –ª–∏–Ω–∏–π
                if (sourceLayer === 'lines') {
                    return {
                        color: feature.properties.stroke_color || '#808080',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1,
                        dashArray: feature.properties.dash_array || ''
                    };
                }

                // –î–ª—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤ (—É—á–∞—Å—Ç–∫–∏ –∑–µ–º–ª–∏)
                if (sourceLayer === 'polygons1') {
                    return {
                        fillColor: feature.properties.fill_color || '#90EE90',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#2d5f2d',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // –î–ª—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤ (—á–∞—Å—Ç–∏ —É—á–∞—Å—Ç–∫–æ–≤)
                if (sourceLayer === 'polygons2') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFB6C1',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#C71585',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // –î–ª—è –ø–æ–ª–∏–≥–æ–Ω–æ–≤ (–¥–æ–º–∞)
                if (sourceLayer === 'polygons3') {
                    return {
                        fillColor: feature.properties.fill_color || '#FFD700',
                        fillOpacity: feature.properties.fill_opacity || 0.8,
                        color: feature.properties.stroke_color || '#DAA520',
                        weight: feature.properties.stroke_width || 2,
                        opacity: 1
                    };
                }

                // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π —Å—Ç–∏–ª—å
                return {
                    fillColor: '#cccccc',
                    fillOpacity: 0.5,
                    color: '#666666',
                    weight: 2,
                    opacity: 1
                };
            }

            // ========================================
            // –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–õ–û–Å–í
            // ========================================

            let combinedLayer;
            let fieldLabelsGroup = L.layerGroup(); // –ì—Ä—É–ø–ø–∞ –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ —É—á–∞—Å—Ç–∫–æ–≤
            let streetLayers = []; // –ú–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏–Ω–∏–π —É–ª–∏—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏
            
            // ========================================
            // –ü–ê–†–ê–õ–õ–ï–õ–¨–ù–ê–Ø –ó–ê–ì–†–£–ó–ö–ê –í–°–ï–• –°–õ–û–Å–í
            // ========================================

            Promise.all([
                fetch('data/map1-polygons.geojson').then(r => r.json()),
                fetch('data/map1-buildings.geojson').then(r => r.json()),
                fetch('data/map1-buildings2.geojson').then(r => r.json()),
                fetch('data/map1-lines.geojson').then(r => r.json())
            ])
            .then(([polygons1Data, polygons3Data, polygons2Data, linesData]) => {
                console.log('‚úì –í—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã');

                // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∂–¥—É—é —Ñ–∏—á—É –∏—Å—Ö–æ–¥–Ω—ã–º —Å–ª–æ–µ–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–∏—è
                polygons1Data.features.forEach(f => f.properties.source_layer = 'polygons1');
                polygons2Data.features.forEach(f => f.properties.source_layer = 'polygons2');
                polygons3Data.features.forEach(f => f.properties.source_layer = 'polygons3');
                linesData.features.forEach(f => f.properties.source_layer = 'lines');

                // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ñ–∏—á–∏ –≤ –æ–¥–∏–Ω –º–∞—Å—Å–∏–≤
                const allFeatures = [
                    ...polygons1Data.features,
                    ...polygons2Data.features,
                    ...polygons3Data.features,
                    ...linesData.features
                ];

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ layer_order (–µ—Å–ª–∏ –Ω–µ—Ç - –≤ –∫–æ–Ω–µ—Ü)
                allFeatures.sort((a, b) => {
                    const orderA = a.properties.layer_order !== undefined ? a.properties.layer_order : Infinity;
                    const orderB = b.properties.layer_order !== undefined ? b.properties.layer_order : Infinity;
                    return orderA - orderB;
                });

                console.log(`‚úì –û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${allFeatures.length} –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ layer_order`);

                // –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π GeoJSON –æ–±—ä–µ–∫—Ç
                const combinedGeoJSON = {
                    type: 'FeatureCollection',
                    features: allFeatures
                };

                // –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π —Å–ª–æ–π
                combinedLayer = L.geoJSON(combinedGeoJSON, {
                    style: getFeatureStyle,
                    onEachFeature: function(feature, layer) {
                        const props = feature.properties;
                        const sourceLayer = props.source_layer;

                        // Popup —Ç–æ–ª—å–∫–æ –¥–ª—è —É—á–∞—Å—Ç–∫–æ–≤ –∑–µ–º–ª–∏ (polygons1)
                        if (sourceLayer === 'polygons1') {
                            let popupContent = '';
                            let hasData = false;

                            if (props.Field_Number) {
                                popupContent += `<div class="popup-info"><b>–ù–æ–º–µ—Ä:</b> ${props.Field_Number}</div>`;
                                hasData = true;
                            }
                            if (props['First and last name of the owners']) {
                                popupContent += `<div class="popup-info"><b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> ${props['First and last name of the owners']}</div>`;
                                hasData = true;
                            }
                            if (props['Length of land plots']) {
                                popupContent += `<div class="popup-info"><b>–î–ª–∏–Ω–∞:</b> ${props['Length of land plots']}</div>`;
                                hasData = true;
                            }
                            if (props['Width of land plots']) {
                                popupContent += `<div class="popup-info"><b>–®–∏—Ä–∏–Ω–∞:</b> ${props['Width of land plots']}</div>`;
                                hasData = true;
                            }

                            // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º popup —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ
                            if (hasData) {
                                layer.bindPopup(popupContent);
                            }

                            // –ú–µ—Ç–∫–∞ —Å –Ω–æ–º–µ—Ä–æ–º —É—á–∞—Å—Ç–∫–∞
                            if (props.Field_Number) {
                                const center = layer.getBounds().getCenter();
                                const marker = L.marker(center, {
                                    icon: L.divIcon({
                                        className: 'field-label',
                                        html: props.Field_Number,
                                        iconSize: [20, 20],
                                        iconAnchor: [10, 10]
                                    })
                                });

                                // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –≤ –≥—Ä—É–ø–ø—É –Ω–æ–º–µ—Ä–æ–≤
                                fieldLabelsGroup.addLayer(marker);
                            }

                            // Hover —ç—Ñ—Ñ–µ–∫—Ç—ã
                            layer.on('mouseover', function() {
                                layer.setStyle({weight: 4, fillOpacity: 0.9});
                            });
                            layer.on('mouseout', function() {
                                combinedLayer.resetStyle(layer);
                            });
                        }

                        // –î–ª—è –¥–æ–º–æ–≤ –∏ —á–∞—Å—Ç–µ–π —É—á–∞—Å—Ç–∫–æ–≤ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º popup —É—á–∞—Å—Ç–∫–∞ –ø–æ–¥ –Ω–∏–º–∏
                        if (sourceLayer === 'polygons2' || sourceLayer === 'polygons3') {
                            layer.on('click', function(e) {
                                // –ò—â–µ–º —É—á–∞—Å—Ç–æ–∫ –∑–µ–º–ª–∏ (polygons1) –ø–æ–¥ –∫–ª–∏–∫–æ–º
                                const clickedPoint = e.latlng;

                                combinedLayer.eachLayer(function(l) {
                                    if (l.feature &&
                                        l.feature.properties.source_layer === 'polygons1' &&
                                        l.getBounds &&
                                        l.getBounds().contains(clickedPoint)) {

                                        // –ï—Å–ª–∏ —É —É—á–∞—Å—Ç–∫–∞ –µ—Å—Ç—å popup, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
                                        if (l.getPopup()) {
                                            l.openPopup(clickedPoint);
                                        }
                                    }
                                });
                            });
                        }

                        // –¢–µ–∫—Å—Ç –≤–¥–æ–ª—å –ª–∏–Ω–∏–∏ –¥–ª—è —É–ª–∏—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º
                        if (sourceLayer === 'lines' && props['Street name'] && props['Street name'] !== null && props['Street name'] !== '') {
                            layer.setText(props['Street name'], {
                                repeat: false,
                                center: true,
                                offset: -8,
                                attributes: {
                                    'class': 'leaflet-text-path',
                                    'dy': '-3'
                                }
                            });

                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–∏–Ω–∏—é –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç—å—é –Ω–∞–∑–≤–∞–Ω–∏–π
                            streetLayers.push(layer);
                        }
                    }
                }).addTo(map);

                console.log('‚úì –ï–¥–∏–Ω—ã–π —Å–ª–æ–π —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –∫–∞—Ä—Ç—É');

                // –°–æ–∑–¥–∞—ë–º –≥—Ä—É–ø–ø—É, –æ–±—ä–µ–¥–∏–Ω—è—é—â—É—é –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫—É—é –∫–∞—Ä—Ç—É –∏ –Ω–æ–º–µ—Ä–∞ —É—á–∞—Å—Ç–∫–æ–≤
                const historicalMapGroup = L.layerGroup([combinedLayer, fieldLabelsGroup]).addTo(map);

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å —Å–ª–æ—ë–≤ (–æ–±–∞ –∫–∞–∫ checkbox'—ã)
                const overlayMaps = {
                    "OpenStreetMap": osmLayer,
                    "–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∞—è –∫–∞—Ä—Ç–∞ 1888": historicalMapGroup
                };

                L.control.layers(null, overlayMaps, {
                    collapsed: false,
                    position: 'topright'
                }).addTo(map);

                // ========================================
                // –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–ò–î–ò–ú–û–°–¢–¨–Æ –ù–û–ú–ï–†–û–í –£–ß–ê–°–¢–ö–û–í –ò –ù–ê–ó–í–ê–ù–ò–ô –£–õ–ò–¶
                // ========================================

                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –Ω–æ–º–µ—Ä–æ–≤ –∏ –Ω–∞–∑–≤–∞–Ω–∏–π —É–ª–∏—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Å—à—Ç–∞–±–∞
                function updateLabelsVisibility() {
                    const zoom = map.getZoom();
                    const minZoom = 18; // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–æ–æ–º –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–¥–ø–∏—Å–µ–π

                    // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–º–µ—Ä–∞ —É—á–∞—Å—Ç–∫–æ–≤
                    fieldLabelsGroup.eachLayer(marker => {
                        const element = marker.getElement();
                        if (element) {
                            if (zoom >= minZoom) {
                                element.classList.remove('field-label-hidden');
                            } else {
                                element.classList.add('field-label-hidden');
                            }
                        }
                    });

                    // –°–∫—Ä—ã–≤–∞–µ–º/–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è —É–ª–∏—Ü
                    streetLayers.forEach(streetLayer => {
                        const pathElement = streetLayer._path;
                        if (pathElement) {
                            // –ò—â–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–Ω—É—Ç—Ä–∏ SVG
                            const textElements = pathElement.parentElement.querySelectorAll('text.leaflet-text-path');
                            textElements.forEach(textElement => {
                                if (zoom >= minZoom) {
                                    textElement.classList.remove('leaflet-text-path-hidden');
                                } else {
                                    textElement.classList.add('leaflet-text-path-hidden');
                                }
                            });
                        }
                    });
                }

                // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
                updateLabelsVisibility();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–∞
                map.on('zoomend', updateLabelsVisibility);

                // ========================================
                // –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –¢–ê–ë–õ–ò–¶–´ –î–ê–ù–ù–´–ú–ò
                // ========================================

                saveTableData(allFeatures);
                populateTable(allTableData);
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–æ—ë–≤:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ data/');
            });

            // ========================================
            // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –¢–ê–ë–õ–ò–¶–ï–ô
            // ========================================

            function populateTable(features) {
                const tableBody = document.getElementById('data-table-body');
                tableBody.innerHTML = '';

                let rowCount = 0;

                features.forEach((feature, index) => {
                    const props = feature.properties;

                    const row = document.createElement('tr');
                    row.dataset.featureIndex = index;

                    // –ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞
                    const displayNumber = props.Field_Number || '-';

                    // –í–ª–∞–¥–µ–ª–µ—Ü
                    let owner = '-';
                    if (props['First and last name of the owners']) {
                        owner = props['First and last name of the owners'];
                    }

                    // –î–ª–∏–Ω–∞
                    const length = props['Length of land plots'] || '-';

                    // –®–∏—Ä–∏–Ω–∞
                    const width = props['Width of land plots'] || '-';

                    row.innerHTML = `
                        <td>${displayNumber}</td>
                        <td><span class="type-badge type-land">–£—á–∞—Å—Ç–æ–∫</span></td>
                        <td>${owner}</td>
                        <td>${length}</td>
                        <td>${width}</td>
                    `;

                    tableBody.appendChild(row);
                    rowCount++;
                });

                console.log(`‚úì –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞: ${rowCount} –∑–∞–ø–∏—Å–µ–π`);

                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∑–∞–ø–∏—Å–µ–π
                document.getElementById('sidebar-header').textContent =
                    `–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ (${rowCount})`;
            }

            // ========================================
            // –ü–û–ò–°–ö –í –¢–ê–ë–õ–ò–¶–ï
            // ========================================

            let allTableData = [];

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
            function saveTableData(features) {
                allTableData = features.filter(feature => {
                    const sourceLayer = feature.properties.source_layer;
                    const props = feature.properties;

                    // –¢–æ–ª—å–∫–æ —É—á–∞—Å—Ç–∫–∏ –∑–µ–º–ª–∏ (polygons1) —Å –Ω–æ–º–µ—Ä–æ–º —É—á–∞—Å—Ç–∫–∞
                    return sourceLayer === 'polygons1' &&
                           props.Field_Number !== null &&
                           props.Field_Number !== undefined &&
                           props.Field_Number !== '';
                });
            }

            // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞
            function searchTable(searchTerm) {
                const term = searchTerm.toLowerCase().trim();

                if (term === '') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                    populateTable(allTableData);
                    return;
                }

                // –§–∏–ª—å—Ç—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                const filtered = allTableData.filter(feature => {
                    const props = feature.properties;

                    // –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É —É—á–∞—Å—Ç–∫–∞
                    const fieldNumber = String(props.Field_Number || '').toLowerCase();
                    if (fieldNumber.includes(term)) return true;

                    // –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
                    const owner = String(props['First and last name of the owners'] || '').toLowerCase();
                    if (owner.includes(term)) return true;

                    return false;
                });

                populateTable(filtered);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞ (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)
            let searchTimeout;
            document.getElementById('search-input').addEventListener('input', function(e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchTable(e.target.value);
                }, 300);
            });
            
            // ========================================
            // –õ–ï–ì–ï–ù–î–ê
            // ========================================
            
            const legend = L.control({position: 'bottomright'});
            
            legend.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML = `
                    <div class="legend-title">–õ–µ–≥–µ–Ω–¥–∞</div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#90EE90; border-color:#2d5f2d;"></span>
                        –£—á–∞—Å—Ç–∫–∏ –∑–µ–º–ª–∏
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFB6C1; border-color:#C71585;"></span>
                        –ß–∞—Å—Ç–∏ —É—á–∞—Å—Ç–∫–æ–≤
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#FFD700; border-color:#DAA520;"></span>
                        –î–æ–º–∞
                    </div>
                    <div class="legend-item">
                        <span class="legend-color" style="background:#808080;"></span>
                        –ì—Ä–∞–Ω–∏—Ü—ã —É–ª–∏—Ü
                    </div>
                `;
                return div;
            };
            
            legend.addTo(map);
            
            // ========================================
            // –ú–ê–°–®–¢–ê–ë
            // ========================================
            
            L.control.scale({
                imperial: false,
                metric: true,
                position: 'bottomleft'
            }).addTo(map);
            
            console.log('üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞! –¶–µ–Ω—Ç—Ä:', mapCenter, 'Zoom:', initialZoom);
        });
    </script>
</body>
</html>
